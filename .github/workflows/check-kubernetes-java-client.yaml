#
# Copyright contributors to the Galasa project
#
# SPDX-License-Identifier: EPL-2.0
#
name: Check Kubernetes Java Client Version

on:
# TODO: Change from on-push back to cron
  # schedule:
  #   # Run daily at 9 AM UTC
  #   - cron: '0 9 * * *'
  push

jobs:
  check-version:
    name: Check latest Kubernetes Java client version from Maven Central
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get latest version from Maven Central
        id: maven-version
        run: |
          # Query Maven Central API for latest version
          LATEST_VERSION=$(curl -s \
            'https://search.maven.org/solrsearch/select?q=g:io.kubernetes+AND+a:client-java&rows=1&wt=json' \
            | jq -r '.response.docs[0].latestVersion')
          
          echo "Latest version: $LATEST_VERSION"
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
      
      - name: Get current version from pom.xml
        id: current-version
        run: |
          CURRENT_VERSION=$(grep -A 1 'io.kubernetes' \
            modules/wrapping/dev.galasa.wrapping.io.kubernetes.client-java/pom.xml \
            | grep '<version>' | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
          
          echo "Current version: $CURRENT_VERSION"
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
      
      - name: Compare versions
        id: compare
        run: |
          LATEST="${{ steps.maven-version.outputs.version }}"
          CURRENT="${{ steps.current-version.outputs.version }}"
          
          if [ "$LATEST" != "$CURRENT" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "⚠️ Version mismatch detected!"
            echo "Current: $CURRENT"
            echo "Latest: $LATEST"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "✅ Version is up to date: $CURRENT"
          fi
      
      - name: Create issue if update needed
        if: steps.compare.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const latest = '${{ steps.maven-version.outputs.version }}';
            const current = '${{ steps.current-version.outputs.version }}';
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['dependency-update', 'kubernetes-client']
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('io.kubernetes:client-java')
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Update io.kubernetes:client-java from ${current} to ${latest}`,
                body: `A new version of the Kubernetes Java client is available.\n\n` +
                      `**Current version:** ${current}\n` +
                      `**Latest version:** ${latest}\n\n` +
                      `**Maven Central:** https://search.maven.org/artifact/io.kubernetes/client-java/${latest}/jar\n\n` +
                      `Please review and update the dependency in:\n` +
                      `- \`modules/wrapping/dev.galasa.wrapping.io.kubernetes.client-java/pom.xml\``,
                labels: ['dependency-update', 'kubernetes-client']
              });
            }
